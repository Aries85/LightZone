<project name="windows" default="jar">

  <tstamp/>

  <!--===== Properties =====================================================-->

  <property name="common-dir" value="../lightcrafts"/>
  <property file="${common-dir}/resources/com/lightcrafts/utils/resources/Version.properties"/>

  <property name="installer-name" value="${app-name}-Installer.exe"/>
  <property name="licensetype" value="ESD"/>
  <property name="windows-jar" value="products/lightcrafts-windows.jar"/>

  <!-- The default maxmemory for the run* targets. -->
  <property name="maxmemory" value="256m"/>

  <exec executable="cat" vmlauncher="false" failonerror="true"
        outputproperty="app-version">
    <arg value="${common-dir}/version.txt"/>
  </exec>

  <condition property="USE_ICC" value="1" else="0">
    <isset property="USE_ICC"/>
  </condition>

  <!--===== Application build ==============================================-->

  <target name="common">
    <ant dir="${common-dir}" target="jar"/>
    <exec executable="make" dir="products" failonerror="true"
          vmlauncher="false"/>
  </target>

  <target name="javac" depends="common">
    <mkdir dir="build"/>
    <javac destdir="build">
      <src path="src"/>
      <classpath>
        <fileset dir="${common-dir}/products">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="lib">
          <include name="*.jar"/>
        </fileset>
      </classpath>
    </javac>
  </target>

  <target name="jni">
    <exec executable="make" dir="jnisrc" failonerror="true" vmlauncher="false"/>
  </target>

  <target name="helpers">
    <exec executable="make" dir="helpers" failonerror="true" vmlauncher="false">
      <arg value="APP_NAME=${app-name}"/>
    </exec>
  </target>

  <target name="build" depends="javac, jni"/>

  <!--===== Make a jar file ================================================-->

  <target name="jar" depends="build">
    <delete file="${windows-jar}"/>
    <jar jarfile="${windows-jar}">
      <fileset dir="build"/>
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Implementation-Vendor" value="${company-name}"/>
        <attribute name="Implementation-Version"
                   value="${app-version} ${TODAY}"/>
      </manifest>
    </jar>
  </target>

  <target name="check-for-jar">
    <condition property="jar-exists">
      <available file="${windows-jar}"/>
    </condition>
  </target>
  
  <target name="jar-if-necessary" depends="check-for-jar" unless="jar-exists">
    <ant target="jar"/>
  </target>

  <!--===== Run the application ============================================-->

  <target name="run" depends="jar-if-necessary">
    <java classname="com.lightcrafts.platform.windows.WindowsLauncher"
          dir="products" failonerror="true" fork="true"
          maxmemory="${maxmemory}">
      <!--
      <jvmarg value="-Xincgc"/>
      -->
      <classpath>
        <fileset dir="products">
          <include name="*.jar"/>
        </fileset>
      </classpath>
      <sysproperty key="java.library.path" value="."/>
      <sysproperty key="com.lightcrafts.zorn" value="true"/>
      <sysproperty key="lightcrafts.debug" value="1"/>
      <sysproperty key="IDE" value="1"/>
    </java>
  </target>

    <!--===== Clean up =======================================================-->

  <target name="clean-up">
    <ant dir="${common-dir}" target="${clean-method}"/>
    <delete dir="build"/>
    <delete file="${installer-name}"/>
    <exec executable="make" dir="helpers">
      <arg value="${clean-method}"/>
    </exec>
    <exec executable="make" dir="jnisrc">
      <arg value="${clean-method}"/>
    </exec>
    <exec executable="make" dir="products">
      <arg value="${clean-method}"/>
    </exec>
    <delete file="products/lightzone.jvmargs"/>
  </target>

  <target name="distclean">
    <antcall target="clean-up">
      <param name="clean-method" value="distclean"/>
    </antcall>
  </target>
  <target name="clean" depends="distclean"/>

  <target name="mostlyclean">
    <antcall target="clean-up">
      <param name="clean-method" value="mostlyclean"/>
    </antcall>
  </target>


    <!-- ======== IZPack stuff ======== -->

    <!--
      Look for IZPack. If IZPACK_HOME is defined, ise it.
      If not, try default installation path.
    -->
    <property environment="env"/>
    <condition property="izPackHome" value="${env.IZPACK_HOME}" else="c:/Program Files (x86)/IzPack">
        <isset property="env.IZPACK_HOME" />
    </condition>

    <path id="build.classpath">
        <fileset dir="${izPackHome}">
            <include name="lib/*.jar" />
        </fileset>
    </path>

    <taskdef name="izpack" classpathref="build.classpath" classname="com.izforge.izpack.ant.IzPackTask" />

    <target name="izpack-installer" depends="jar, helpers">

    <copy file="helpers/JavaAppLauncher/${app-name}.exe"
              tofile="products/${app-name}.exe" overwrite="true"/>
        <chmod file="products/${app-name}.exe" perm="775"/>
        <copy file="helpers/JavaAppLauncher/${app-name}.ico"
              tofile="products/${app-name}.ico" overwrite="true"/>

        <exec executable="make" dir="resources/sign" failonerror="true"
              vmlauncher="false">
            <arg value="EXE_TO_SIGN=../../products/${app-name}.exe"/>
        </exec>

        <copy file="helpers/JavaAppLauncher/lightzone.jvmargs" todir="products"
              overwrite="true">
        </copy>

        <exec executable="make" dir="resources/help" failonerror="true"
              vmlauncher="false">
            <arg value="APP_NAME=${app-name}"/>
        </exec>

        <izpack input="windows/installer/lightzone.izpack.xml"
                output="LightZone-install.jar"
                installerType="standard"
                basedir="${basedir}/products"
                izPackDir="c:\Program Files (x86)\IzPack"
                inheritAll="true"
                />

    </target>

</project>
<!-- vim:set et sw=2 ts=2: -->
